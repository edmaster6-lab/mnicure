<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nails Manager</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8bbd0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-pink: #f8bbd0;
            --dark-pink: #f06292;
            --light-pink: #fce4ec;
            --text-color: #4a4a4a;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-pink);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 { color: var(--dark-pink); text-align: center; }

        /* Bot√µes Principais */
        .header-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background-color: var(--dark-pink);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: 0.3s;
        }

        .btn:active { transform: scale(0.95); }

        /* Filtros na Tela Principal */
        .search-area {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .input-filter {
            padding: 10px;
            border: 1px solid var(--primary-pink);
            border-radius: 20px;
            outline: none;
            box-sizing: border-box;
        }

        /* Lista de Agendamentos */
        #agenda-lista {
            width: 100%;
            max-width: 500px;
        }

        .card-agenda {
            background: var(--white);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 15px;
            border-left: 5px solid var(--dark-pink);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .agenda-info { font-weight: bold; margin-bottom: 10px; }
        .agenda-actions { display: flex; gap: 15px; justify-content: flex-end; }
        .agenda-actions i { font-size: 1.5rem; cursor: pointer; color: var(--dark-pink); }

        /* Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid var(--primary-pink);
            border-radius: 10px;
            box-sizing: border-box;
        }

        .photo-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 10px auto;
            border: 2px dashed var(--dark-pink);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        .remove-photo {
            position: absolute;
            top: 0; right: 0;
            background: red;
            color: white;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            z-index: 10;
        }

        .cliente-item {
            padding: 10px;
            border-bottom: 1px solid var(--light-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <h2><i class="fas fa-hand-sparkles"></i> Nails Manager</h2>

    <div class="header-buttons">
        <button class="btn" onclick="openModal('modalCadastro')"><i class="fas fa-user-plus"></i> Novo Cliente</button>
        <button class="btn" onclick="openModalClientes()"><i class="fas fa-users"></i> Clientes</button>
        <button class="btn" onclick="openModal('modalConfig')"><i class="fas fa-cog"></i></button>
    </div>

    <div class="search-area">
        <input type="date" id="filtroData" class="input-filter" onchange="renderAgenda()">
        <input type="text" id="filtroNome" class="input-filter" placeholder="üîç Buscar por nome..." oninput="renderAgenda()">
    </div>

    <div id="agenda-lista"></div>

    <div id="modalCadastro" class="modal">
        <div class="modal-content">
            <h3>Cadastro de Cliente</h3>
            <div class="photo-container" onclick="document.getElementById('inputFoto').click()">
                <i id="cam-icon" class="fas fa-camera" style="color: #ccc;"></i>
                <img id="preview-img">
                <span id="btn-remove-photo" class="remove-photo" onclick="removePhoto(event)">X</span>
            </div>
            <input type="file" id="inputFoto" accept="image/*" capture="camera" hidden onchange="handleFile(this)">
            <input type="text" id="nome" placeholder="Nome Completo">
            <input type="tel" id="telefone" placeholder="WhatsApp (ex: 5511999999999)">
            <textarea id="obs" placeholder="Observa√ß√µes"></textarea>
            <button class="btn" style="width:100%" onclick="salvarCliente()">Salvar Cliente</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="closeModal('modalCadastro')">Fechar</button>
        </div>
    </div>

    <div id="modalClientes" class="modal">
        <div class="modal-content">
            <h3>Meus Clientes</h3>
            <div id="lista-clientes-corpo"></div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeModal('modalClientes')">Voltar</button>
        </div>
    </div>

    <div id="modalAgendar" class="modal">
        <div class="modal-content">
            <h3>Agendar Hor√°rio</h3>
            <p id="nome-cliente-agendando" style="font-weight:bold; color:var(--dark-pink)"></p>
            <input type="date" id="data-agendamento">
            <input type="time" id="hora-agendamento">
            <button class="btn" style="width:100%" onclick="salvarAgendamento()">Confirmar Agendamento</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="closeModal('modalAgendar')">Cancelar</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h3>Configura√ß√µes</h3>
            <label>Mensagem de Confirma√ß√£o:</label>
            <textarea id="msgConfirma" rows="3"></textarea>
            <label>Mensagem de Cancelamento:</label>
            <textarea id="msgCancela" rows="3"></textarea>
            <hr>
            <button class="btn" style="width:100%; background:#4caf50" onclick="exportBackup()">Exportar Backup</button>
            <button class="btn" style="width:100%; background:#2196f3; margin-top:5px" onclick="importBackup()">Restaurar Backup</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="closeModal('modalConfig')">Fechar</button>
        </div>
    </div>

    <script>
        let db = {
            clientes: JSON.parse(localStorage.getItem('nails_clientes')) || [],
            agendamentos: JSON.parse(localStorage.getItem('nails_agendamentos')) || [],
            config: JSON.parse(localStorage.getItem('nails_config')) || {
                msgConfirma: "Ol√° [NOME], seu agendamento est√° confirmado para o dia [DATA] √†s [HORA].",
                msgCancela: "Ol√° [NOME], seu agendamento do dia [DATA] foi cancelado."
            }
        };

        let clienteSelecionadoIndex = null;
        let fotoBase64 = "";

        window.onload = function() {
            document.getElementById('filtroData').value = new Date().toISOString().split('T')[0];
            document.getElementById('msgConfirma').value = db.config.msgConfirma;
            document.getElementById('msgCancela').value = db.config.msgCancela;
            renderAgenda();
        };

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function handleFile(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    fotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-img').src = fotoBase64;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('cam-icon').style.display = 'none';
                    document.getElementById('btn-remove-photo').style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        function removePhoto(e) {
            e.stopPropagation();
            fotoBase64 = "";
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('cam-icon').style.display = 'block';
            document.getElementById('btn-remove-photo').style.display = 'none';
            document.getElementById('inputFoto').value = "";
        }

        function salvarCliente() {
            const nome = document.getElementById('nome').value;
            const tel = document.getElementById('telefone').value;
            if(!nome || !tel) return alert("Preencha nome e telefone!");
            db.clientes.push({ nome, tel, obs: document.getElementById('obs').value, foto: fotoBase64 });
            salvarLS();
            closeModal('modalCadastro');
            limparForm();
        }

        function openModalClientes() {
            const corpo = document.getElementById('lista-clientes-corpo');
            corpo.innerHTML = "";
            db.clientes.forEach((cli, i) => {
                corpo.innerHTML += `<div class="cliente-item">
                    <span>${cli.nome}</span>
                    <div>
                        <i class="fas fa-calendar-plus" onclick="prepararAgendamento(${i})" style="color:green; margin-right:10px"></i>
                        <i class="fas fa-trash" onclick="excluirCliente(${i})" style="color:red"></i>
                    </div>
                </div>`;
            });
            openModal('modalClientes');
        }

        function excluirCliente(i) {
            if(confirm("Excluir cliente?")) { db.clientes.splice(i, 1); salvarLS(); openModalClientes(); }
        }

        function prepararAgendamento(i) {
            clienteSelecionadoIndex = i;
            document.getElementById('nome-cliente-agendando').innerText = "Cliente: " + db.clientes[i].nome;
            closeModal('modalClientes');
            openModal('modalAgendar');
        }

        function salvarAgendamento() {
            const data = document.getElementById('data-agendamento').value;
            const hora = document.getElementById('hora-agendamento').value;
            const cliente = db.clientes[clienteSelecionadoIndex];
            if(!data || !hora) return alert("Data e hora obrigat√≥rios!");
            if(db.agendamentos.find(a => a.data === data && a.hora === hora)) return alert("Hor√°rio ocupado!");

            db.agendamentos.push({ nome: cliente.nome, tel: cliente.tel, data, hora });
            salvarLS();
            renderAgenda();
            enviarWhats(cliente.tel, db.config.msgConfirma, cliente.nome, data, hora);
            closeModal('modalAgendar');
        }

        function renderAgenda() {
            const lista = document.getElementById('agenda-lista');
            const fData = document.getElementById('filtroData').value;
            const fNome = document.getElementById('filtroNome').value.toLowerCase();
            lista.innerHTML = `<h3 style="text-align:center; font-size:1em">Agenda de ${fData.split('-').reverse().join('/')}</h3>`;

            const filtrados = db.agendamentos.filter(a => a.data === fData && a.nome.toLowerCase().includes(fNome));
            
            filtrados.sort((a,b) => a.hora.localeCompare(b.hora)).forEach(ag => {
                const realIdx = db.agendamentos.indexOf(ag);
                lista.innerHTML += `<div class="card-agenda">
                    <div class="agenda-info">${ag.hora} - ${ag.nome}</div>
                    <div class="agenda-actions">
                        <i class="fab fa-whatsapp" onclick="enviarWhats('${ag.tel}', db.config.msgConfirma, '${ag.nome}', '${ag.data}', '${ag.hora}')" style="color:#25D366"></i>
                        <i class="fas fa-check-circle" onclick="concluir(${realIdx})" style="color:green"></i>
                        <i class="fas fa-times-circle" onclick="cancelar(${realIdx})" style="color:red"></i>
                    </div>
                </div>`;
            });
        }

        function concluir(i) { db.agendamentos.splice(i, 1); salvarLS(); renderAgenda(); }

        function cancelar(i) {
            if(confirm("Cancelar este agendamento?")) {
                const ag = db.agendamentos[i];
                enviarWhats(ag.tel, db.config.msgCancela, ag.nome, ag.data, ag.hora);
                db.agendamentos.splice(i, 1);
                salvarLS();
                renderAgenda();
            }
        }

        function enviarWhats(tel, msgBase, nome, data, hora) {
            const dtFormat = data.split('-').reverse().join('/');
            let msg = msgBase.replace("[NOME]", nome).replace("[DATA]", dtFormat).replace("[HORA]", hora);
            window.open(`https://api.whatsapp.com/send?phone=${tel}&text=${encodeURIComponent(msg)}`, '_blank');
        }

        function salvarLS() {
            localStorage.setItem('nails_clientes', JSON.stringify(db.clientes));
            localStorage.setItem('nails_agendamentos', JSON.stringify(db.agendamentos));
            localStorage.setItem('nails_config', JSON.stringify(db.config));
        }

        function exportBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = dataStr; a.download = "backup.json"; a.click();
        }

        function importBackup() {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => { db = JSON.parse(ev.target.result); salvarLS(); location.reload(); };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function limparForm() {
            document.getElementById('nome').value = ""; document.getElementById('telefone').value = "";
            document.getElementById('obs').value = ""; removePhoto({stopPropagation: ()=>{}});
        }

        document.getElementById('msgConfirma').onchange = (e) => { db.config.msgConfirma = e.target.value; salvarLS(); };
        document.getElementById('msgCancela').onchange = (e) => { db.config.msgCancela = e.target.value; salvarLS(); };
    </script>
</body>
</html>
