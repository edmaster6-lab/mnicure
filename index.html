<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nails Manager Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8bbd0">
    <link rel="apple-touch-icon" href="icone.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-pink: #f8bbd0;
            --dark-pink: #f06292;
            --light-pink: #fce4ec;
            --text-color: #4a4a4a;
            --white: #ffffff;
            --danger: #ff5252;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-pink);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 { color: var(--dark-pink); text-align: center; margin-bottom: 15px; }

        /* Container de Filtros na Home */
        .filter-box {
            width: 100%;
            max-width: 500px;
            background: var(--white);
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .filter-box input {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: 1px solid var(--primary-pink);
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* Botões de Ação Principal */
        .main-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
        }

        .btn-main {
            flex: 1;
            background-color: var(--dark-pink);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-config {
            background: var(--white);
            color: var(--dark-pink);
            width: 50px;
            border-radius: 15px;
            border: 1px solid var(--primary-pink);
        }

        /* Listagem de Agendamentos */
        #agenda-lista {
            width: 100%;
            max-width: 500px;
        }

        .card-agenda {
            background: var(--white);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 18px;
            border-left: 6px solid var(--dark-pink);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agenda-details b { color: var(--dark-pink); font-size: 1.1em; }
        .agenda-details p { margin: 5px 0 0; font-size: 0.9em; opacity: 0.8; }

        .agenda-actions { display: flex; gap: 12px; }
        .agenda-actions i { font-size: 1.4rem; cursor: pointer; transition: 0.2s; }
        .fa-whatsapp { color: #25D366; }
        .fa-check-circle { color: #4caf50; }
        .fa-times-circle { color: var(--danger); }

        /* Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: var(--white);
            padding: 25px;
            border-radius: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        /* Foto e Upload */
        .photo-wrapper {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border: 3px dashed var(--primary-pink);
            border-radius: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #fafafa;
            overflow: hidden;
            cursor: pointer;
        }

        #preview-img { width: 100%; height: 100%; object-fit: cover; }
        .delete-photo-btn {
            position: absolute;
            top: 5px; right: 5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 25px; height: 25px;
            text-align: center; line-height: 25px;
            font-weight: bold; font-size: 14px;
        }

        /* Utilitários */
        .btn-block { width: 100%; margin-top: 10px; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--dark-pink); color: white; }
        .btn-cancel { background: #eee; color: #666; }

        .cliente-item {
            padding: 15px;
            border-bottom: 1px solid var(--light-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <h2><i class="fas fa-magic"></i> Nails Manager</h2>

    <div class="main-nav">
        <button class="btn-main" onclick="openModal('modalCadastro')">
            <i class="fas fa-user-plus"></i> Cliente
        </button>
        <button class="btn-main" onclick="listarClientes()">
            <i class="fas fa-users"></i> Lista
        </button>
        <button class="btn-main btn-config" onclick="openModal('modalConfig')">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <div class="filter-box">
        <label style="font-size: 0.8em; font-weight: bold; color: var(--dark-pink);">FILTRAR POR DATA</label>
        <input type="date" id="filtroData" onchange="renderAgenda()">
        <input type="text" id="filtroNome" placeholder="Pesquisar agendamento por nome..." oninput="renderAgenda()">
    </div>

    <div id="agenda-lista"></div>

    <div id="modalCadastro" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center">Novo Cadastro</h3>
            <div class="photo-wrapper" onclick="document.getElementById('inputFoto').click()">
                <i id="placeholder-cam" class="fas fa-camera" style="font-size: 2rem; color: #ddd;"></i>
                <img id="preview-img" style="display:none">
                <div id="btn-del-photo" class="delete-photo-btn" style="display:none" onclick="removerFoto(event)">X</div>
            </div>
            <input type="file" id="inputFoto" accept="image/*" capture="camera" hidden onchange="processarFoto(this)">
            <input type="text" id="cadNome" placeholder="Nome da Cliente">
            <input type="tel" id="cadTel" placeholder="WhatsApp (DDD + Número)">
            <textarea id="cadObs" placeholder="Observações (Alergias, cores favoritas...)" rows="3"></textarea>
            <button class="btn-block btn-save" onclick="salvarCliente()">CADASTRAR</button>
            <button class="btn-block btn-cancel" onclick="fecharCadastro()">FECHAR</button>
        </div>
    </div>

    <div id="modalListaClientes" class="modal">
        <div class="modal-content">
            <h3>Clientes Cadastrados</h3>
            <div id="corpo-lista-clientes"></div>
            <button class="btn-block btn-cancel" onclick="closeModal('modalListaClientes')">VOLTAR</button>
        </div>
    </div>

    <div id="modalAgendar" class="modal">
        <div class="modal-content">
            <h3>Novo Agendamento</h3>
            <p id="label-cliente-agenda" style="font-weight:bold"></p>
            <input type="date" id="agendaData">
            <input type="time" id="agendaHora">
            <button class="btn-block btn-save" onclick="confirmarAgendamento()">SALVAR AGENDAMENTO</button>
            <button class="btn-block btn-cancel" onclick="closeModal('modalAgendar')">CANCELAR</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h3>Configurações e Mensagens</h3>
            <label>Mensagem de Confirmação:</label>
            <textarea id="cfgConfirma" rows="3"></textarea>
            <label>Mensagem de Cancelamento:</label>
            <textarea id="cfgCancela" rows="3"></textarea>
            <hr>
            <button class="btn-block" style="background: #4caf50; color: white;" onclick="exportarDados()">BACKUP (EXPORTAR)</button>
            <button class="btn-block" style="background: #2196f3; color: white;" onclick="importarDados()">RESTAURAR (IMPORTAR)</button>
            <button class="btn-block btn-cancel" onclick="closeModal('modalConfig')">FECHAR</button>
        </div>
    </div>

    <script>
        // Banco de Dados Local
        let appData = {
            clientes: JSON.parse(localStorage.getItem('nail_db_cli')) || [],
            agenda: JSON.parse(localStorage.getItem('nail_db_age')) || [],
            config: JSON.parse(localStorage.getItem('nail_db_cfg')) || {
                confirma: "Olá [NOME], passando para confirmar seu horário no dia [DATA] às [HORA]. Podemos confirmar?",
                cancela: "Olá [NOME], seu agendamento do dia [DATA] às [HORA] foi cancelado."
            }
        };

        let tempClienteIndex = null;
        let fotoData = "";

        // Ao carregar: Define data de hoje no filtro
        window.onload = () => {
            document.getElementById('filtroData').value = new Date().toISOString().split('T')[0];
            document.getElementById('cfgConfirma').value = appData.config.confirma;
            document.getElementById('cfgCancela').value = appData.config.cancela;
            renderAgenda();
        };

        // Funções de Modal
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Processamento de Foto (Redimensionamento para poupar memória)
        function processarFoto(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const max_size = 300;
                    let w = img.width;
                    let h = img.height;
                    if (w > h) { if (w > max_size) { h *= max_size / w; w = max_size; } }
                    else { if (h > max_size) { w *= max_size / h; h = max_size; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    fotoData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('preview-img').src = fotoData;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('placeholder-cam').style.display = 'none';
                    document.getElementById('btn-del-photo').style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }

        function removerFoto(e) {
            e.stopPropagation();
            fotoData = "";
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('placeholder-cam').style.display = 'block';
            document.getElementById('btn-del-photo').style.display = 'none';
            document.getElementById('inputFoto').value = "";
        }

        // Gestão de Clientes
        function salvarCliente() {
            const nome = document.getElementById('cadNome').value;
            const tel = document.getElementById('cadTel').value;
            const obs = document.getElementById('cadObs').value;
            if(!nome || !tel) return alert("Preencha o nome e telefone!");

            appData.clientes.push({ nome, tel, obs, foto: fotoData });
            saveDB();
            fecharCadastro();
            alert("Cliente cadastrada!");
        }

        function listarClientes() {
            const corpo = document.getElementById('corpo-lista-clientes');
            corpo.innerHTML = appData.clientes.length ? "" : "Nenhuma cliente cadastrada.";
            appData.clientes.forEach((c, i) => {
                corpo.innerHTML += `
                    <div class="cliente-item">
                        <div><b>${c.nome}</b><br><small>${c.tel}</small></div>
                        <div>
                            <i class="fas fa-calendar-plus" style="color:var(--dark-pink); margin-right:15px" onclick="abrirAgendamento(${i})"></i>
                            <i class="fas fa-trash-alt" style="color:#ccc" onclick="excluirCliente(${i})"></i>
                        </div>
                    </div>
                `;
            });
            openModal('modalListaClientes');
        }

        function excluirCliente(i) {
            if(confirm("Deseja remover esta cliente?")) {
                appData.clientes.splice(i, 1);
                saveDB();
                listarClientes();
            }
        }

        // Gestão de Agenda
        function abrirAgendamento(i) {
            tempClienteIndex = i;
            document.getElementById('label-cliente-agenda').innerText = "Cliente: " + appData.clientes[i].nome;
            closeModal('modalListaClientes');
            openModal('modalAgendar');
        }

        function confirmarAgendamento() {
            const data = document.getElementById('agendaData').value;
            const hora = document.getElementById('agendaHora').value;
            if(!data || !hora) return alert("Escolha data e hora!");

            const conflito = appData.agenda.find(a => a.data === data && a.hora === hora);
            if(conflito) return alert("Agenda ocupada! Escolha outro horário.");

            const cliente = appData.clientes[tempClienteIndex];
            appData.agenda.push({
                nome: cliente.nome,
                tel: cliente.tel,
                data: data,
                hora: hora
            });

            saveDB();
            renderAgenda();
            closeModal('modalAgendar');
            dispararWhats(cliente.tel, appData.config.confirma, cliente.nome, data, hora);
        }

        function renderAgenda() {
            const lista = document.getElementById('agenda-lista');
            const fData = document.getElementById('filtroData').value;
            const fNome = document.getElementById('filtroNome').value.toLowerCase();
            
            lista.innerHTML = "";
            
            const filtrados = appData.agenda.filter(a => {
                return a.data === fData && a.nome.toLowerCase().includes(fNome);
            });

            if(!filtrados.length) {
                lista.innerHTML = `<p style="text-align:center; opacity:0.5">Sem agendamentos para esta data.</p>`;
                return;
            }

            filtrados.sort((a,b) => a.hora.localeCompare(b.hora)).forEach(a => {
                const idx = appData.agenda.indexOf(a);
                lista.innerHTML += `
                    <div class="card-agenda">
                        <div class="agenda-details">
                            <b>${a.hora} - ${a.nome}</b>
                            <p><i class="fas fa-phone-alt"></i> ${a.tel}</p>
                        </div>
                        <div class="agenda-actions">
                            <i class="fab fa-whatsapp" onclick="dispararWhats('${a.tel}', appData.config.confirma, '${a.nome}', '${a.data}', '${a.hora}')"></i>
                            <i class="fas fa-check-circle" onclick="concluir(${idx})"></i>
                            <i class="fas fa-times-circle" onclick="cancelar(${idx})"></i>
                        </div>
                    </div>
                `;
            });
        }

        function concluir(i) {
            appData.agenda.splice(i, 1);
            saveDB();
            renderAgenda();
        }

        function cancelar(i) {
            if(confirm("Confirmar cancelamento do agendamento?")) {
                const a = appData.agenda[i];
                dispararWhats(a.tel, appData.config.cancela, a.nome, a.data, a.hora);
                appData.agenda.splice(i, 1);
                saveDB();
                renderAgenda();
            }
        }

        // WhatsApp e Configs
        function dispararWhats(tel, msgBase, nome, data, hora) {
            const dtFormat = data.split('-').reverse().join('/');
            let msg = msgBase.replace("[NOME]", nome).replace("[DATA]", dtFormat).replace("[HORA]", hora);
            window.open(`https://api.whatsapp.com/send?phone=55${tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
        }

        function saveDB() {
            localStorage.setItem('nail_db_cli', JSON.stringify(appData.clientes));
            localStorage.setItem('nail_db_age', JSON.stringify(appData.agenda));
            localStorage.setItem('nail_db_cfg', JSON.stringify(appData.config));
        }

        // Backup e Restauração
        function exportarDados() {
            const blob = new Blob([JSON.stringify(appData)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "backup_nails.json"; a.click();
        }

        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    appData = JSON.parse(ev.target.result);
                    saveDB();
                    location.reload();
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function fecharCadastro() {
            closeModal('modalCadastro');
            document.getElementById('cadNome').value = "";
            document.getElementById('cadTel').value = "";
            document.getElementById('cadObs').value = "";
            removerFoto({stopPropagation: ()=>{}});
        }

        // Atualizar mensagens de config ao digitar
        document.getElementById('cfgConfirma').oninput = (e) => { appData.config.confirma = e.target.value; saveDB(); };
        document.getElementById('cfgCancela').oninput = (e) => { appData.config.cancela = e.target.value; saveDB(); };
    </script>
</body>
</html>
