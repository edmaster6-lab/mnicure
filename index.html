<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nails Manager Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8bbd0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-pink: #f8bbd0;
            --dark-pink: #f06292;
            --light-pink: #fce4ec;
            --text-color: #4a4a4a;
            --white: #ffffff;
            --success-bg: #e8f5e9;
            --cancel-bg: #ffebee;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-pink);
            color: var(--text-color);
            margin: 0;
            padding: 10px 10px 60px 10px; /* Ajuste para n√£o cobrir o rodap√© */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2 { color: var(--dark-pink); text-align: center; margin-bottom: 10px; }

        .header-buttons {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;
        }

        .btn {
            background-color: var(--dark-pink); color: white; border: none; padding: 12px 20px;
            border-radius: 25px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-area {
            width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;
        }

        .input-filter {
            padding: 10px; border: 1px solid var(--primary-pink); border-radius: 20px; outline: none;
        }

        #agenda-lista { width: 100%; max-width: 500px; }

        .card-agenda {
            background: var(--white); margin-bottom: 10px; padding: 15px; border-radius: 15px;
            border-left: 5px solid var(--dark-pink); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .agenda-info { font-weight: bold; margin-bottom: 10px; }
        .agenda-actions { display: flex; gap: 15px; justify-content: flex-end; }
        .agenda-actions i { font-size: 1.5rem; cursor: pointer; color: var(--dark-pink); }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }

        .modal-content {
            background: var(--white); padding: 20px; border-radius: 20px; width: 90%;
            max-width: 420px; max-height: 85vh; overflow-y: auto;
        }

        input, textarea {
            width: 100%; padding: 10px; margin: 8px 0; border: 1px solid var(--primary-pink);
            border-radius: 10px; box-sizing: border-box;
        }

        .photo-container {
            position: relative; width: 100px; height: 100px; margin: 10px auto;
            border: 2px dashed var(--dark-pink); border-radius: 50%; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .photo-fichario {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--primary-pink); display: block; margin: 0 auto 10px;
        }

        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .remove-photo {
            position: absolute; top: 5px; right: 5px; background: red; color: white;
            padding: 2px 6px; cursor: pointer; border-radius: 50%; font-size: 10px;
        }

        .historico-item {
            padding: 8px 12px; margin-bottom: 5px; border-radius: 8px; font-size: 0.85em;
            display: flex; justify-content: space-between;
        }
        .status-concluido { background-color: var(--success-bg); color: #2e7d32; }
        .status-cancelado { background-color: var(--cancel-bg); color: #c62828; }

        .cliente-item {
            padding: 12px; border-bottom: 1px solid var(--light-pink);
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }

        /* Rodap√© Assinatura */
        .footer-credit {
            position: fixed; bottom: 10px; width: 100%; text-align: center;
            font-size: 12px; color: var(--dark-pink); opacity: 0.8; z-index: 500;
            cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <h2><i class="fas fa-gem"></i> Nails Manager</h2>

    <div class="header-buttons">
        <button class="btn" onclick="openModal('modalCadastro')"><i class="fas fa-user-plus"></i> Novo Cliente</button>
        <button class="btn" onclick="openModalClientes()"><i class="fas fa-users"></i> Clientes</button>
        <button class="btn" onclick="openModal('modalConfig')"><i class="fas fa-cog"></i></button>
    </div>

    <div class="search-area">
        <input type="date" id="filtroData" class="input-filter" onchange="renderAgenda()">
        <input type="text" id="filtroNome" class="input-filter" placeholder="üîç Buscar na agenda..." oninput="renderAgenda()">
    </div>

    <div id="agenda-lista"></div>

    <div class="footer-credit" onclick="openModal('modalSobre')">by Edmaster App</div>

    <div id="modalSobre" class="modal">
        <div class="modal-content" style="text-align: center;">
            <img src="ed.png" alt="Edmaster" style="max-width: 150px; border-radius: 15px; margin-bottom: 15px;">
            <h3 style="color: var(--dark-pink);">Agradecimento</h3>
            <p style="font-size: 0.95em; color: var(--text-color); line-height: 1.5;">
                Agradecemos por escolher o <strong>Nails Manager</strong> para gerir seu neg√≥cio. √â uma honra fazer parte da sua jornada profissional.
            </p>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeModal('modalSobre')">Fechar</button>
        </div>
    </div>

    <div id="modalCadastro" class="modal">
        <div class="modal-content">
            <h3 id="titulo-modal-cliente">Novo Cadastro</h3>
            <div class="photo-container" onclick="document.getElementById('inputFoto').click()">
                <i id="cam-icon" class="fas fa-camera" style="color: #ccc;"></i>
                <img id="preview-img">
                <span id="btn-remove-photo" class="remove-photo" onclick="removePhoto(event)">X</span>
            </div>
            <input type="file" id="inputFoto" accept="image/*" capture="camera" hidden onchange="handleFile(this)">
            <input type="text" id="nome" placeholder="Nome Completo">
            <input type="tel" id="telefone" placeholder="WhatsApp (DDD + N√∫mero)">
            <textarea id="obs" placeholder="Observa√ß√µes e Prefer√™ncias"></textarea>
            <button class="btn" style="width:100%" id="btn-salvar-cli" onclick="salvarCliente()">Salvar Cliente</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="fecharCadastro()">Fechar</button>
        </div>
    </div>

    <div id="modalClientes" class="modal">
        <div class="modal-content">
            <h3>Minhas Clientes</h3>
            <div id="lista-clientes-corpo"></div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeModal('modalClientes')">Voltar</button>
        </div>
    </div>

    <div id="modalFicha" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:5px">Ficha da Cliente</h3>
            <img id="ficha-foto" class="photo-fichario" src="https://via.placeholder.com/120?text=Sem+Foto">
            <div style="text-align:center; margin-bottom:15px">
                <strong id="ficha-nome" style="font-size:1.2em"></strong><br>
                <span id="ficha-tel" style="color:#666"></span>
            </div>
            <p><strong>Obs:</strong> <span id="ficha-obs"></span></p>
            <div style="display:flex; gap:5px; margin-bottom:15px">
                <button class="btn" style="flex:1; background:#2196f3; font-size:0.8em" onclick="editarClienteFicha()"><i class="fas fa-edit"></i> Editar Dados</button>
                <button class="btn" style="flex:1; background:#f44336; font-size:0.8em" onclick="excluirClienteFicha()"><i class="fas fa-trash"></i> Excluir Cliente</button>
            </div>
            <hr>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h4>Hist√≥rico</h4>
                <span onclick="limparHistorico()" style="font-size:0.7em; color:red; cursor:pointer; text-decoration:underline">Limpar Hist√≥rico</span>
            </div>
            <div id="ficha-historico"></div>
            <div style="display:flex; gap:5px; margin-top:15px">
                <button class="btn" style="flex:1" onclick="prepararAgendamentoFicha()"><i class="fas fa-calendar-alt"></i> Agendar</button>
                <button class="btn" style="background:#444" onclick="closeModal('modalFicha')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modalAgendar" class="modal">
        <div class="modal-content">
            <h3>Agendar Hor√°rio</h3>
            <p id="nome-cliente-agendando" style="font-weight:bold"></p>
            <input type="date" id="data-agendamento">
            <input type="time" id="hora-agendamento">
            <button class="btn" style="width:100%" onclick="salvarAgendamento()">Confirmar e Enviar WhatsApp</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="closeModal('modalAgendar')">Cancelar</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h3>Configura√ß√µes</h3>
            <label>Mensagem de Confirma√ß√£o:</label>
            <textarea id="msgConfirma" rows="4"></textarea>
            <label>Mensagem de Cancelamento:</label>
            <textarea id="msgCancela" rows="3"></textarea>
            <button class="btn" style="width:100%; background:#4caf50; margin-top:10px" onclick="exportBackup()">Fazer Backup</button>
            <button class="btn" style="width:100%; background:#2196f3; margin-top:5px" onclick="importBackup()">Restaurar Backup</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:5px" onclick="closeModal('modalConfig')">Fechar</button>
        </div>
    </div>

    <script>
        let db = {
            clientes: JSON.parse(localStorage.getItem('nails_clientes')) || [],
            agendamentos: JSON.parse(localStorage.getItem('nails_agendamentos')) || [],
            historico: JSON.parse(localStorage.getItem('nails_historico')) || [],
            config: JSON.parse(localStorage.getItem('nails_config')) || {
                msgConfirma: "Ol√°, [NOME]! ‚ú®\n\nConfirmamos seu hor√°rio de atendimento para o dia [DATA] √†s [HORA]. Estou ansiosa para deixar suas unhas impec√°veis! Em caso de imprevistos, por favor me avise com anteced√™ncia. At√© logo! ü•∞",
                msgCancela: "Ol√°, [NOME]. ‚ú®\n\nInfelizmente seu agendamento do dia [DATA] precisou ser cancelado. Para remarcar uma nova data, basta me chamar por aqui. Agrade√ßo a compreens√£o!"
            }
        };

        let selecionadaIdx = null;
        let fotoBase64 = "";
        let editandoIndex = null;

        window.onload = function() {
            document.getElementById('filtroData').value = new Date().toISOString().split('T')[0];
            document.getElementById('msgConfirma').value = db.config.msgConfirma;
            document.getElementById('msgCancela').value = db.config.msgCancela;
            renderAgenda();
        };

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function handleFile(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX = 300;
                    let scale = MAX / img.width;
                    canvas.width = MAX; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    fotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-img').src = fotoBase64;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('cam-icon').style.display = 'none';
                    document.getElementById('btn-remove-photo').style.display = 'block';
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function removePhoto(e) {
            if(e) e.stopPropagation(); 
            fotoBase64 = "";
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('cam-icon').style.display = 'block';
            document.getElementById('btn-remove-photo').style.display = 'none';
            document.getElementById('inputFoto').value = "";
        }

        function salvarCliente() {
            const nome = document.getElementById('nome').value;
            const tel = document.getElementById('telefone').value;
            const obs = document.getElementById('obs').value;
            if(!nome || !tel) return alert("Nome e Telefone s√£o essenciais.");
            
            if(editandoIndex !== null) {
                db.clientes[editandoIndex] = { nome, tel, obs, foto: fotoBase64 };
                editandoIndex = null;
            } else {
                db.clientes.push({ nome, tel, obs, foto: fotoBase64 });
            }
            salvarLS(); fecharCadastro(); openModalClientes();
        }

        function editarClienteFicha() {
            editandoIndex = selecionadaIdx;
            const cli = db.clientes[editandoIndex];
            document.getElementById('titulo-modal-cliente').innerText = "Editar Cliente";
            document.getElementById('nome').value = cli.nome;
            document.getElementById('telefone').value = cli.tel;
            document.getElementById('obs').value = cli.obs;
            if(cli.foto) {
                fotoBase64 = cli.foto;
                document.getElementById('preview-img').src = fotoBase64;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('cam-icon').style.display = 'none';
                document.getElementById('btn-remove-photo').style.display = 'block';
            }
            closeModal('modalFicha');
            openModal('modalCadastro');
        }

        function excluirClienteFicha() {
            if(confirm("Deseja realmente excluir esta cliente e todos os seus registros?")) {
                db.clientes.splice(selecionadaIdx, 1);
                salvarLS();
                closeModal('modalFicha');
                openModalClientes();
            }
        }

        function limparHistorico() {
            if(confirm("Deseja limpar o hist√≥rico desta cliente?")) {
                const tel = db.clientes[selecionadaIdx].tel;
                db.historico = db.historico.filter(h => h.tel !== tel);
                salvarLS();
                abrirFicha(selecionadaIdx);
            }
        }

        function openModalClientes() {
            const corpo = document.getElementById('lista-clientes-corpo');
            corpo.innerHTML = "";
            db.clientes.forEach((cli, i) => {
                corpo.innerHTML += `<div class="cliente-item" onclick="abrirFicha(${i})">
                    <span>${cli.nome}</span>
                    <i class="fas fa-chevron-right" style="color:#ddd"></i>
                </div>`;
            });
            openModal('modalClientes');
        }

        function abrirFicha(i) {
            selecionadaIdx = i;
            const cli = db.clientes[i];
            document.getElementById('ficha-nome').innerText = cli.nome;
            document.getElementById('ficha-tel').innerText = cli.tel;
            document.getElementById('ficha-obs').innerText = cli.obs || "Nenhuma observa√ß√£o.";
            document.getElementById('ficha-foto').src = cli.foto || "https://via.placeholder.com/120?text=Sem+Foto";
            
            const histCorpo = document.getElementById('ficha-historico');
            histCorpo.innerHTML = "";
            const meusHist = db.historico.filter(h => h.tel === cli.tel);
            if(meusHist.length === 0) histCorpo.innerHTML = "<small>Nenhum registro anterior.</small>";
            meusHist.reverse().forEach(h => {
                const classe = h.status === 'Conclu√≠do' ? 'status-concluido' : 'status-cancelado';
                histCorpo.innerHTML += `<div class="historico-item ${classe}">
                    <span>${h.data.split('-').reverse().join('/')} √†s ${h.hora}</span>
                    <strong>${h.status}</strong>
                </div>`;
            });

            closeModal('modalClientes');
            openModal('modalFicha');
        }

        function prepararAgendamentoFicha() {
            document.getElementById('nome-cliente-agendando').innerText = "Cliente: " + db.clientes[selecionadaIdx].nome;
            closeModal('modalFicha');
            openModal('modalAgendar');
        }

        function salvarAgendamento() {
            const data = document.getElementById('data-agendamento').value;
            const hora = document.getElementById('hora-agendamento').value;
            const cliente = db.clientes[selecionadaIdx];
            if(!data || !hora) return alert("Preencha data e hora.");
            if(db.agendamentos.find(a => a.data === data && a.hora === hora)) return alert("Hor√°rio indispon√≠vel!");

            db.agendamentos.push({ nome: cliente.nome, tel: cliente.tel, data, hora });
            salvarLS(); renderAgenda();
            enviarWhats(cliente.tel, db.config.msgConfirma, cliente.nome, data, hora);
            closeModal('modalAgendar');
        }

        function renderAgenda() {
            const lista = document.getElementById('agenda-lista');
            const fData = document.getElementById('filtroData').value;
            const fNome = document.getElementById('filtroNome').value.toLowerCase();
            lista.innerHTML = `<h3 style="text-align:center">${fData.split('-').reverse().join('/')}</h3>`;

            const filtrados = db.agendamentos.filter(a => a.data === fData && a.nome.toLowerCase().includes(fNome));
            filtrados.sort((a,b) => a.hora.localeCompare(b.hora)).forEach(ag => {
                const realIdx = db.agendamentos.indexOf(ag);
                lista.innerHTML += `<div class="card-agenda">
                    <div class="agenda-info">${ag.hora} - ${ag.nome}</div>
                    <div class="agenda-actions">
                        <i class="fab fa-whatsapp" onclick="enviarWhats('${ag.tel}', db.config.msgConfirma, '${ag.nome}', '${ag.data}', '${ag.hora}')" style="color:#25D366"></i>
                        <i class="fas fa-check-circle" onclick="finalizar(${realIdx}, 'Conclu√≠do')" style="color:#4caf50"></i>
                        <i class="fas fa-times-circle" onclick="cancelar(${realIdx})" style="color:#f44336"></i>
                    </div>
                </div>`;
            });
        }

        function finalizar(i, status) {
            const ag = db.agendamentos[i];
            db.historico.push({ ...ag, status });
            db.agendamentos.splice(i, 1);
            salvarLS(); renderAgenda();
        }

        function cancelar(i) {
            if(confirm("Deseja realmente cancelar? O cliente receber√° um aviso.")) {
                const ag = db.agendamentos[i];
                enviarWhats(ag.tel, db.config.msgCancela, ag.nome, ag.data, ag.hora);
                finalizar(i, 'Cancelado');
            }
        }

        function enviarWhats(tel, msgBase, nome, data, hora) {
            const dt = data.split('-').reverse().join('/');
            let msg = msgBase.replace("[NOME]", nome).replace("[DATA]", dt).replace("[HORA]", hora);
            window.open(`https://api.whatsapp.com/send?phone=55${tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
        }

        function salvarLS() {
            localStorage.setItem('nails_clientes', JSON.stringify(db.clientes));
            localStorage.setItem('nails_agendamentos', JSON.stringify(db.agendamentos));
            localStorage.setItem('nails_historico', JSON.stringify(db.historico));
            localStorage.setItem('nails_config', JSON.stringify(db.config));
        }

        function fecharCadastro() {
            closeModal('modalCadastro');
            limparForm();
        }

        function limparForm() {
            editandoIndex = null;
            document.getElementById('titulo-modal-cliente').innerText = "Novo Cadastro";
            document.getElementById('nome').value = ""; document.getElementById('telefone').value = "";
            document.getElementById('obs').value = ""; removePhoto();
        }

        function exportBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = dataStr; a.download = "nails_backup.json"; a.click();
        }

        function importBackup() {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => { db = JSON.parse(ev.target.result); salvarLS(); location.reload(); };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        document.getElementById('msgConfirma').onchange = (e) => { db.config.msgConfirma = e.target.value; salvarLS(); };
        document.getElementById('msgCancela').onchange = (e) => { db.config.msgCancela = e.target.value; salvarLS(); };
    </script>
</body>
</html>
